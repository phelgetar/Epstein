<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epstein DOJ Files â€” Document Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --paper: #FAF8F3;
            --ink-dark: #1A1512;
            --ink-medium: #463E3A;
            --ink-light: #8A817C;
            --accent: #C1440E;
            --accent-muted: #D4774E;
            --border: #E0D9CF;
            --highlight: #FFF4E6;
            --shadow: rgba(26, 21, 18, 0.08);
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--paper);
            color: var(--ink-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(26, 21, 18, 0.01) 2px, rgba(26, 21, 18, 0.01) 4px);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Header */
        header {
            border-bottom: 3px solid var(--ink-dark);
            padding: 3rem 0 2rem;
            margin-bottom: 3rem;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent);
        }

        h1 {
            font-size: 4rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            line-height: 1;
            margin-bottom: 0.5rem;
            color: var(--ink-dark);
        }

        .subtitle {
            font-size: 1.25rem;
            color: var(--ink-medium);
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        /* Search Section */
        .search-section {
            margin-bottom: 3rem;
            background: white;
            border: 2px solid var(--ink-dark);
            box-shadow: 8px 8px 0 var(--shadow);
            position: relative;
        }

        .search-section::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: var(--accent);
        }

        .search-header {
            background: var(--ink-dark);
            color: var(--paper);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--ink-dark);
        }

        .search-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .search-body {
            padding: 2rem;
        }

        .search-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 1.25rem 4rem 1.25rem 1.5rem;
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.25rem;
            border: 2px solid var(--border);
            background: var(--paper);
            color: var(--ink-dark);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(193, 68, 14, 0.1);
        }

        .search-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .search-button:hover {
            background: var(--ink-dark);
        }

        .search-button:active {
            transform: translateY(-50%) scale(0.98);
        }

        .search-options {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            padding: 1.5rem 0 0;
            border-top: 1px solid var(--border);
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .option-group label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-medium);
            cursor: pointer;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .option-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        /* Filter Panel */
        .filter-panel {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 0;
            user-select: none;
        }

        .filter-toggle {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
        }

        .filter-body { padding: 1rem 0 0; }

        .filter-row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .filter-group { flex: 1; min-width: 200px; }

        .filter-label {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--ink-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .dataset-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .dataset-checkboxes label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            color: var(--ink-medium);
        }

        .dataset-checkboxes input { accent-color: var(--accent); }

        .filter-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            background: var(--paper);
        }

        .filter-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            background: var(--paper);
            color: var(--ink-dark);
            min-width: 200px;
        }

        .page-range {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-light);
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-medium);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-number {
            font-weight: 600;
            color: var(--accent);
            font-size: 1.25rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.25rem;
            color: var(--ink-medium);
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 300px;
            height: 6px;
            background: var(--border);
            margin: 1rem auto 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.2s ease;
        }

        .progress-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--ink-light);
            margin-top: 0.5rem;
        }

        /* Search overlay */
        .search-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 248, 243, 0.85);
            z-index: 10;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 1rem;
        }

        .search-overlay.active {
            display: flex;
        }

        /* Results */
        .results {
            display: none;
            position: relative;
        }

        .results.active {
            display: block;
        }

        .results-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--ink-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-count {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--ink-dark);
        }

        .results-actions { display: flex; gap: 0.5rem; }

        .export-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: white;
            color: var(--ink-medium);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
        }

        .export-btn:hover { border-color: var(--accent); color: var(--accent); }

        .result-item {
            background: white;
            border: 2px solid var(--ink-dark);
            margin-bottom: 2rem;
            box-shadow: 6px 6px 0 var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: slideIn 0.4s ease;
        }

        .result-item:hover {
            transform: translateX(2px) translateY(-2px);
            box-shadow: 8px 8px 0 var(--shadow);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            background: var(--ink-dark);
            color: var(--paper);
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
            border-bottom: 2px solid var(--ink-dark);
        }

        .result-title {
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            word-break: break-word;
        }

        .result-badge {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 2px;
            white-space: nowrap;
            margin-left: 1rem;
        }

        .result-meta {
            padding: 1rem 1.5rem;
            background: var(--highlight);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-medium);
        }

        .result-body {
            padding: 1.5rem;
        }

        .match-context {
            background: var(--paper);
            border-left: 4px solid var(--accent);
            padding: 1.25rem;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            line-height: 1.7;
            position: relative;
        }

        .match-context:last-of-type {
            margin-bottom: 0;
        }

        .match-context.collapsed {
            display: none;
        }

        .match-context mark {
            background: var(--accent);
            color: white;
            padding: 0.125rem 0.25rem;
            font-weight: 600;
        }

        .match-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--ink-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .match-toggle, .match-toggle-all {
            background: none;
            border: none;
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0;
        }

        .match-toggle { margin-left: 1rem; }

        .match-toggle:hover, .match-toggle-all:hover { text-decoration: underline; }

        .match-toggle-all {
            display: block;
            margin: 1rem 0 0.5rem;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .page-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: white;
            color: var(--ink-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover { border-color: var(--accent); color: var(--accent); }
        .page-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .page-btn:disabled { opacity: 0.4; cursor: default; }

        .page-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--ink-light);
            margin: 0 0.5rem;
        }

        /* No results */
        .no-results {
            text-align: center;
            padding: 4rem;
            display: none;
        }

        .no-results.active {
            display: block;
        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .no-results-text {
            font-size: 1.5rem;
            color: var(--ink-medium);
            margin-bottom: 0.5rem;
        }

        .no-results-hint {
            color: var(--ink-light);
            font-size: 1rem;
        }

        /* PDF Viewer Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 21, 18, 0.95);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 95%;
            height: 95%;
            max-width: 1400px;
            border: 3px solid var(--ink-dark);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: var(--ink-dark);
            color: var(--paper);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--ink-dark);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            word-break: break-word;
        }

        .modal-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 1rem;
        }

        .modal-close:hover {
            background: var(--ink-dark);
            transform: scale(1.05);
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            background: var(--paper);
        }

        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-error {
            padding: 4rem;
            text-align: center;
            color: var(--ink-medium);
        }

        .pdf-error-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* PDF Link in results */
        .pdf-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent);
            color: white;
            padding: 0.5rem 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pdf-link:hover {
            background: var(--ink-dark);
            transform: translateX(2px);
        }

        .pdf-link::before {
            content: 'ðŸ“„';
            font-size: 1rem;
        }

        /* Footer */
        footer {
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 2px solid var(--border);
            text-align: center;
            color: var(--ink-light);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .search-section {
                box-shadow: 4px 4px 0 var(--shadow);
            }

            .search-body {
                padding: 1.5rem;
            }

            .search-button {
                position: static;
                transform: none;
                width: 100%;
                margin-top: 1rem;
            }

            .search-input {
                padding: 1.25rem 1.5rem;
            }

            .stats {
                flex-direction: column;
                gap: 1rem;
            }

            .result-header {
                flex-direction: column;
                gap: 0.75rem;
            }

            .result-badge {
                margin-left: 0;
            }

            .result-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap;gap:1rem;">
                <div>
                    <h1>Epstein DOJ Files</h1>
                    <p class="subtitle">Document Search & Analysis System</p>
                </div>
                <a href="/static/gallery.html" style="font-family:'JetBrains Mono',monospace;font-size:0.875rem;color:var(--accent);text-decoration:none;text-transform:uppercase;letter-spacing:0.05em;padding:0.5rem 1rem;border:2px solid var(--accent);transition:all 0.2s ease;" onmouseover="this.style.background='var(--accent)';this.style.color='white'" onmouseout="this.style.background='';this.style.color='var(--accent)'">Gallery</a>
            </div>
        </header>

        <main>
            <div class="search-section">
                <div class="search-header">
                    <h2>Search Documents</h2>
                </div>
                <div class="search-body">
                    <div class="search-wrapper">
                        <input
                            type="text"
                            id="searchInput"
                            class="search-input"
                            placeholder="e.g., &quot;grand jury&quot; AND Maxwell NOT flight â€” or â€” Epstein NEAR/5 island"
                            autocomplete="off"
                        >
                        <button id="searchButton" class="search-button">Search</button>
                    </div>

                    <div class="search-options">
                        <div class="option-group">
                            <input type="checkbox" id="caseSensitive">
                            <label for="caseSensitive">Case Sensitive</label>
                        </div>
                        <div class="option-group">
                            <input type="checkbox" id="wholeWord">
                            <label for="wholeWord">Whole Words Only</label>
                        </div>
                        <div class="option-group">
                            <input type="checkbox" id="regex">
                            <label for="regex">Regular Expression</label>
                        </div>
                    </div>

                    <div class="filter-panel">
                        <div class="filter-header" onclick="toggleFilterPanel()">
                            <span>Filters & Sorting</span>
                            <span class="filter-toggle" id="filterToggle">+</span>
                        </div>
                        <div class="filter-body" id="filterBody" style="display:none;">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label class="filter-label">Dataset</label>
                                    <select id="datasetFilter" class="filter-select" onchange="onFilterChange()">
                                        <option value="">All Datasets</option>
                                        <option value="1">Data Set 1</option>
                                        <option value="2">Data Set 2</option>
                                        <option value="3">Data Set 3</option>
                                        <option value="4">Data Set 4</option>
                                        <option value="5">Data Set 5</option>
                                        <option value="6">Data Set 6</option>
                                        <option value="7">Data Set 7</option>
                                        <option value="8">Data Set 8</option>
                                        <option value="9">Data Set 9</option>
                                        <option value="10">Data Set 10</option>
                                        <option value="11">Data Set 11</option>
                                        <option value="12">Data Set 12</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Page Count</label>
                                    <div class="page-range">
                                        <input type="number" id="minPages" placeholder="Min" min="0" class="filter-input">
                                        <span>to</span>
                                        <input type="number" id="maxPages" placeholder="Max" min="0" class="filter-input">
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Sort By</label>
                                    <select id="sortBy" class="filter-select">
                                        <option value="relevance">Relevance (match count)</option>
                                        <option value="filename">Filename (A-Z)</option>
                                        <option value="dataset">Dataset Number</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat">
                    <span class="stat-number" id="totalDocs">0</span>
                    <span>Documents Indexed</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="totalPages">0</span>
                    <span>Total Pages</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="searchTime">0</span>
                    <span>Search Time (ms)</span>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Connecting to server...</p>
            </div>

            <div class="results" id="results">
                <div class="search-overlay" id="searchOverlay">
                    <div class="spinner" style="width:24px;height:24px;border-width:3px;margin-right:1rem;"></div>
                    Searching...
                </div>
                <div class="results-header">
                    <div class="results-count" id="resultsCount"></div>
                    <div class="results-actions">
                        <button class="export-btn" onclick="exportResults('csv')">Export CSV</button>
                        <button class="export-btn" onclick="exportResults('json')">Export JSON</button>
                    </div>
                </div>
                <div id="resultsContainer"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <div class="no-results" id="noResults">
                <div class="no-results-icon">ðŸ“„</div>
                <div class="no-results-text">No documents found</div>
                <div class="no-results-hint">Try different search terms or check your filters</div>
            </div>
        </main>

        <!-- PDF Viewer Modal -->
        <div class="modal" id="pdfModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="pdfModalTitle">Document Viewer</div>
                    <button class="modal-close" onclick="closePdfModal()">Close</button>
                </div>
                <div class="modal-body" id="pdfModalBody">
                    <iframe class="pdf-viewer" id="pdfViewer"></iframe>
                </div>
            </div>
        </div>

        <footer>
            <p>Epstein DOJ Files Search System â€” Data from justice.gov/epstein/doj-disclosures</p>
        </footer>
    </div>

    <script>
        // â”€â”€â”€ Global State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        let lastQuery = '';
        let paginationState = { currentPage: 1, perPage: 20, totalPages: 0, totalResults: 0 };
        let lastApiResponse = null;

        // â”€â”€â”€ Load Stats on Startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function loadStats() {
            try {
                const resp = await fetch('/api/stats');
                const data = await resp.json();

                document.getElementById('totalDocs').textContent = data.total_docs;
                document.getElementById('totalPages').textContent = data.total_pages.toLocaleString();
                document.getElementById('stats').style.display = 'flex';
                document.getElementById('searchTime').closest('.stat').style.display = 'none';

                document.getElementById('loading').classList.remove('active');
            } catch (e) {
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div class="no-results-icon">&#x26A0;&#xFE0F;</div>
                    <div class="no-results-text">Could not connect to server</div>
                    <div class="no-results-hint">${escapeHtml(e.message)}</div>
                `;
                loadingEl.classList.add('active');
            }
        }

        // â”€â”€â”€ Build Search URL Params â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function getSearchParams(page, perPage) {
            const params = new URLSearchParams();
            params.set('q', document.getElementById('searchInput').value.trim());
            params.set('page', page);
            params.set('per_page', perPage);

            const dataset = document.getElementById('datasetFilter').value;
            if (dataset) params.set('dataset', dataset);

            const minPages = document.getElementById('minPages').value;
            if (minPages) params.set('min_pages', minPages);

            const maxPages = document.getElementById('maxPages').value;
            if (maxPages) params.set('max_pages', maxPages);

            params.set('sort', document.getElementById('sortBy').value);
            params.set('case_sensitive', document.getElementById('caseSensitive').checked);
            params.set('whole_word', document.getElementById('wholeWord').checked);
            params.set('use_regex', document.getElementById('regex').checked);

            return params;
        }

        // â”€â”€â”€ Execute Search via API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function executeSearch(page) {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            if (page === undefined) page = 1;
            lastQuery = query;
            paginationState.currentPage = page;

            const resultsEl = document.getElementById('results');
            const noResultsEl = document.getElementById('noResults');
            const overlay = document.getElementById('searchOverlay');

            resultsEl.classList.add('active');
            noResultsEl.classList.remove('active');
            overlay.classList.add('active');

            const startTime = performance.now();

            try {
                const params = getSearchParams(page, paginationState.perPage);
                const resp = await fetch('/api/search?' + params.toString());
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || `Server error (${resp.status})`);
                }

                const elapsed = Math.round(performance.now() - startTime);
                const searchTimeStat = document.getElementById('searchTime').closest('.stat');
                searchTimeStat.style.display = 'flex';
                document.getElementById('searchTime').textContent = elapsed;

                lastApiResponse = data;
                paginationState.totalResults = data.total;
                paginationState.totalPages = Math.ceil(data.total / data.perPage);

                displayResults(data);
            } catch (e) {
                console.error('Search error:', e);
                resultsEl.classList.remove('active');
                noResultsEl.classList.add('active');
                document.querySelector('.no-results-hint').textContent = e.message;
            } finally {
                overlay.classList.remove('active');
            }
        }

        // â”€â”€â”€ Display Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function displayResults(data) {
            const resultsEl = document.getElementById('results');
            const noResultsEl = document.getElementById('noResults');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsCount = document.getElementById('resultsCount');

            if (data.total === 0) {
                resultsEl.classList.remove('active');
                noResultsEl.classList.add('active');
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            noResultsEl.classList.remove('active');
            resultsEl.classList.add('active');

            resultsCount.textContent =
                `${data.total} document${data.total === 1 ? '' : 's'} found` +
                ` (${data.totalMatches.toLocaleString()} total match${data.totalMatches === 1 ? '' : 'es'})`;

            resultsContainer.innerHTML = data.results.map((result, index) => {
                return renderResultItem(result, index);
            }).join('');

            renderPagination(data.total, paginationState.totalPages, data.page);
        }

        function renderResultItem(result, index) {
            const highlightTerms = getHighlightTerms(lastQuery);

            const matchesHtml = result.contexts.map((ctx, mIndex) => {
                let highlightedText = escapeHtml(ctx.context);

                for (const term of highlightTerms) {
                    try {
                        const escaped = escapeRegex(term);
                        highlightedText = highlightedText.replace(
                            new RegExp(`(${escaped})`, 'gi'),
                            '<mark>$1</mark>'
                        );
                    } catch (e) {}
                }

                const pageLabel = ctx.page ? ` \u2014 Page ${ctx.page}` : '';
                const collapsedClass = mIndex >= 3 ? ' collapsed' : '';

                return `
                    <div class="match-context${collapsedClass}" data-match-index="${mIndex}">
                        <div class="match-label">Match ${mIndex + 1}${pageLabel}</div>
                        <div>${highlightedText}</div>
                    </div>
                `;
            }).join('');

            const extraCount = result.contexts.length - 3;
            const toggleAllHtml = extraCount > 0
                ? `<button class="match-toggle-all" onclick="toggleAllMatches(this)">Show ${extraCount} more match${extraCount === 1 ? '' : 'es'}</button>`
                : '';

            const firstPage = (result.contexts.length > 0 && result.contexts[0].page) ? result.contexts[0].page : null;
            const pdfPageArg = firstPage ? `, ${firstPage}` : '';

            return `
                <div class="result-item" style="animation-delay: ${(index % 20) * 0.03}s">
                    <div class="result-header">
                        <div class="result-title">${escapeHtml(result.filename)}</div>
                        <div class="result-badge">Data Set ${result.dataset}</div>
                    </div>
                    <div class="result-meta">
                        <div>\uD83D\uDCC4 ${result.pages} page${result.pages === 1 ? '' : 's'}</div>
                        <div>\uD83D\uDD0D ${result.match_count} match${result.match_count === 1 ? '' : 'es'}</div>
                    </div>
                    <div class="result-body">
                        ${matchesHtml}
                        ${toggleAllHtml}
                        <button class="pdf-link" onclick="openPdfModal('${escapeHtml(result.filepath).replace(/'/g, "\\'")}', '${escapeHtml(result.filename).replace(/'/g, "\\'")}'${pdfPageArg})">
                            View PDF
                        </button>
                    </div>
                </div>
            `;
        }

        // â”€â”€â”€ Highlight Term Extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function getHighlightTerms(query) {
            if (!query) return [];
            const terms = [];

            // Extract quoted phrases
            const phrases = [];
            let working = query.replace(/"([^"]+)"/g, (_, phrase) => {
                phrases.push(phrase);
                return `__PH${phrases.length - 1}__`;
            });

            function restore(s) {
                return s.replace(/__PH(\d+)__/g, (_, idx) => phrases[parseInt(idx)]);
            }

            // Extract NEAR/N terms
            working = working.replace(/(\S+)\s+NEAR\/\d+\s+(\S+)/gi, (_, t1, t2) => {
                terms.push(restore(t1), restore(t2));
                return '';
            });

            // Remove NOT terms
            if (/ NOT /i.test(working)) {
                working = working.split(/ NOT /i)[0];
            }

            // Split on AND/OR
            working = working.trim();
            if (/ AND /i.test(working)) {
                terms.push(...working.split(/ AND /i).map(t => restore(t.trim())).filter(Boolean));
            } else if (/ OR /i.test(working)) {
                terms.push(...working.split(/ OR /i).map(t => restore(t.trim())).filter(Boolean));
            } else {
                const t = restore(working).trim();
                if (t) terms.push(t);
            }

            return terms.filter(Boolean);
        }

        // â”€â”€â”€ Filter & Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function toggleFilterPanel() {
            const body = document.getElementById('filterBody');
            const toggle = document.getElementById('filterToggle');
            const visible = body.style.display !== 'none';
            body.style.display = visible ? 'none' : 'block';
            toggle.textContent = visible ? '+' : '\u2212';
        }

        function onFilterChange() {
            if (lastQuery) {
                executeSearch(1);
            }
        }

        // â”€â”€â”€ Expand/Collapse Matches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function toggleAllMatches(btn) {
            const body = btn.closest('.result-body');
            const collapsed = body.querySelectorAll('.match-context.collapsed');
            if (collapsed.length > 0) {
                collapsed.forEach(el => el.classList.remove('collapsed'));
                btn.textContent = 'Hide extra matches';
            } else {
                body.querySelectorAll('.match-context').forEach((el, i) => {
                    if (i >= 3) el.classList.add('collapsed');
                });
                const total = body.querySelectorAll('.match-context').length;
                const extra = total - 3;
                btn.textContent = `Show ${extra} more match${extra === 1 ? '' : 'es'}`;
            }
        }

        // â”€â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function renderPagination(totalResults, totalPages, currentPage) {
            const pag = document.getElementById('pagination');
            if (totalPages <= 1) { pag.innerHTML = ''; return; }

            let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>`;

            const pages = getPageNumbers(currentPage, totalPages);
            for (const p of pages) {
                if (p === '...') {
                    html += `<span class="page-info">...</span>`;
                } else {
                    html += `<button class="page-btn${p === currentPage ? ' active' : ''}" onclick="goToPage(${p})">${p}</button>`;
                }
            }

            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            html += `<span class="page-info">${totalResults} results</span>`;
            pag.innerHTML = html;
        }

        function getPageNumbers(current, total) {
            if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
            const pages = [1];
            if (current > 3) pages.push('...');
            for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
                pages.push(i);
            }
            if (current < total - 2) pages.push('...');
            pages.push(total);
            return pages;
        }

        function goToPage(page) {
            if (page < 1 || page > paginationState.totalPages) return;
            executeSearch(page);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async function exportResults(format) {
            if (!lastQuery) return;

            // Fetch all results (up to 10000) for export
            const params = getSearchParams(1, 10000);
            try {
                const resp = await fetch('/api/search?' + params.toString());
                const data = await resp.json();

                if (!resp.ok || data.results.length === 0) return;

                if (format === 'csv') {
                    const header = 'Filename,Dataset,Pages,Matches\n';
                    const rows = data.results.map(r =>
                        `"${r.filename}",${r.dataset},${r.pages},${r.match_count}`
                    ).join('\n');
                    downloadFile(header + rows, 'search-results.csv', 'text/csv');
                } else if (format === 'json') {
                    const exported = data.results.map(r => ({
                        filename: r.filename,
                        dataset: r.dataset,
                        pages: r.pages,
                        filepath: r.filepath,
                        matchCount: r.match_count,
                        contexts: r.contexts.map(c => ({
                            match: c.match,
                            page: c.page || null,
                            position: c.position
                        }))
                    }));
                    downloadFile(JSON.stringify(exported, null, 2), 'search-results.json', 'application/json');
                }
            } catch (e) {
                console.error('Export error:', e);
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // â”€â”€â”€ Utility Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // â”€â”€â”€ PDF Viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // iOS/iPad Safari cannot render multi-page PDFs inside iframes â€”
        // it only shows the first page. Detect iOS and open in a new tab.
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        function openPdfModal(filepath, filename, pageNumber) {
            const url = pageNumber ? filepath + '#page=' + pageNumber : filepath;

            // iOS: open in new tab where Safari's native viewer works fully
            if (isIOS) {
                window.open(url, '_blank');
                return;
            }

            const modal = document.getElementById('pdfModal');
            const title = document.getElementById('pdfModalTitle');
            const viewer = document.getElementById('pdfViewer');
            const body = document.getElementById('pdfModalBody');

            title.textContent = filename;
            viewer.src = url;

            viewer.onerror = function() {
                body.innerHTML = `
                    <div class="pdf-error">
                        <div class="pdf-error-icon">&#x26A0;&#xFE0F;</div>
                        <div class="no-results-text">Could not load PDF</div>
                        <div class="no-results-hint">File path: ${escapeHtml(filepath)}</div>
                        <div style="margin-top: 1rem;">
                            <a href="${escapeHtml(filepath)}" target="_blank" class="pdf-link">
                                Open in New Tab
                            </a>
                        </div>
                    </div>
                `;
            };

            modal.classList.add('active');
            document.addEventListener('keydown', handleEscapeKey);
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const viewer = document.getElementById('pdfViewer');
            const body = document.getElementById('pdfModalBody');

            modal.classList.remove('active');
            viewer.src = '';
            body.innerHTML = '<iframe class="pdf-viewer" id="pdfViewer"></iframe>';

            document.removeEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(e) {
            if (e.key === 'Escape') closePdfModal();
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('pdfModal')) closePdfModal();
        });

        // â”€â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        let searchDebounceTimer = null;

        document.getElementById('searchButton').addEventListener('click', () => executeSearch());

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') executeSearch();
        });

        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            const val = document.getElementById('searchInput').value.trim();
            if (val.length >= 3) {
                searchDebounceTimer = setTimeout(() => executeSearch(), 400);
            }
        });

        document.getElementById('minPages').addEventListener('change', onFilterChange);
        document.getElementById('maxPages').addEventListener('change', onFilterChange);
        document.getElementById('sortBy').addEventListener('change', onFilterChange);

        // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        loadStats();
    </script>
</body>
</html>
